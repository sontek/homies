#!/usr/bin/env bash
# ralph-prd - Execute tasks from PRD document
# Orchestrates multiple Ralph runs, one per PRD task

set -euo pipefail

# Detect script directory to find ralph
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RALPH_CMD="$SCRIPT_DIR/ralph"

# Configuration (inherited by ralph)
RALPH_MAX_ITERATIONS="${RALPH_MAX_ITERATIONS:-50}"
RALPH_CLAUDE_COMMAND="${RALPH_CLAUDE_COMMAND:-claude-jail}"
RALPH_AUTO_APPROVE_PUSH="${RALPH_AUTO_APPROVE_PUSH:-false}"

# PRD-specific configuration
PRD_FILE=""
PRD_STATUS_FILE=".ralph/prd-status.json"
RESUME_MODE=false
DRY_RUN=false

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $*"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $*"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $*"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $*"
}

log_prd() {
    echo -e "${PURPLE}[PRD]${NC} $*"
}

# Usage
usage() {
    cat <<EOF
Usage: ralph-prd [OPTIONS] <PRD_FILE>

Execute tasks from a Product Requirements Document using Ralph.
Each task goes through Ralph's full Phase 1-9 workflow.

Arguments:
    PRD_FILE    Path to PRD markdown file

Options:
    --help              Show this help
    --resume            Resume from last incomplete task
    --dry-run           Show tasks without executing
    --status            Show current PRD status and exit

Environment Variables:
    RALPH_MAX_ITERATIONS      Max iterations per task (default: 50)
    RALPH_CLAUDE_COMMAND      Claude command: claude-jail, claude, or custom (default: claude-jail)
    RALPH_AUTO_APPROVE_PUSH   Skip push approval (default: false)

PRD Format:
    # Product Requirements

    ## High Priority
    - [ ] Add user authentication system
    - [ ] Create user profile management
    - [ ] Build admin dashboard

    ## Medium Priority
    - [ ] Add email notification system
    - [ ] Implement file upload feature

    ## Low Priority
    - [ ] Dark mode toggle
    - [ ] Export data to CSV

    ## Completed
    - [x] Project initialization

    ## Notes
    - Authentication is blocker for other features
    - Use existing design system

Task Format:
    - Each task should be concrete and implementable
    - Task description becomes Ralph's prompt
    - Ralph will create detailed plan and execute all phases
    - Good: "Add JWT authentication with refresh tokens"
    - Bad: "Make it better" (too vague)

Examples:
    ralph-prd PRD.md
    ralph-prd requirements.md --resume
    ralph-prd PRD.md --dry-run

    # Use native claude instead of docker
    RALPH_CLAUDE_COMMAND=claude ralph-prd PRD.md

    # Higher iteration limit per task
    RALPH_MAX_ITERATIONS=75 ralph-prd PRD.md

EOF
}

# Get next unchecked task by priority
get_next_task() {
    local prd_file="$1"

    [ ! -f "$prd_file" ] && return 1

    # Try High Priority first, then Medium, then Low
    # Use state machine to properly handle section boundaries
    local task=$(awk '
        /^## High Priority/ { in_high = 1; next }
        /^## Medium Priority/ { in_high = 0; in_medium = 1; next }
        /^## Low Priority/ { in_high = 0; in_medium = 0; in_low = 1; next }
        /^## / { in_high = 0; in_medium = 0; in_low = 0; next }

        in_high && /^- \[ \]/ {
            sub(/^- \[ \] /, "");
            print;
            exit
        }
    ' "$prd_file")

    # Then Medium Priority
    if [ -z "$task" ]; then
        task=$(awk '
            /^## Medium Priority/ { in_section = 1; next }
            /^## / { in_section = 0; next }

            in_section && /^- \[ \]/ {
                sub(/^- \[ \] /, "");
                print;
                exit
            }
        ' "$prd_file")
    fi

    # Then Low Priority
    if [ -z "$task" ]; then
        task=$(awk '
            /^## Low Priority/ { in_section = 1; next }
            /^## / { in_section = 0; next }

            in_section && /^- \[ \]/ {
                sub(/^- \[ \] /, "");
                print;
                exit
            }
        ' "$prd_file")
    fi

    echo "$task"
}

# Get task priority
get_task_priority() {
    local prd_file="$1"
    local task="$2"

    # Escape special characters for awk regex
    local escaped_task=$(echo "$task" | sed 's/[]\/$*.^[]/\\&/g')

    # Use state machine to check which section contains this task
    local priority=$(awk -v task="$escaped_task" '
        /^## High Priority/ { section = "High"; next }
        /^## Medium Priority/ { section = "Medium"; next }
        /^## Low Priority/ { section = "Low"; next }
        /^## / { section = ""; next }

        section != "" && $0 ~ "^- \\[ \\] " task "$" {
            print section
            exit
        }
    ' "$prd_file")

    if [ -z "$priority" ]; then
        echo "Unknown"
    else
        echo "$priority"
    fi
}

# Mark task complete in PRD
mark_complete() {
    local prd_file="$1"
    local task="$2"

    # Escape special characters for sed
    local escaped_task=$(echo "$task" | sed 's/[\/&]/\\&/g')

    # Create backup
    cp "$prd_file" "${prd_file}.bak"

    # Replace [ ] with [x] for this task
    # Use a more robust sed pattern
    sed -i.tmp "/^- \[ \] ${escaped_task}$/s/\[ \]/[x]/" "$prd_file"
    rm -f "${prd_file}.tmp"

    log_success "Marked complete in PRD: $task"
}

# Check if PRD has unchecked tasks
has_tasks() {
    local prd_file="$1"
    grep -q '^- \[ \]' "$prd_file" 2>/dev/null
}

# Count tasks by status
count_tasks() {
    local prd_file="$1"

    local total=$(grep -c '^- \[.\]' "$prd_file" 2>/dev/null || echo "0")
    local completed=$(grep -c '^- \[x\]' "$prd_file" 2>/dev/null || echo "0")
    local remaining=$(grep -c '^- \[ \]' "$prd_file" 2>/dev/null || echo "0")

    echo "$completed/$total complete ($remaining remaining)"
}

# Count tasks by priority
count_by_priority() {
    local prd_file="$1"

    # Use state machine to count unchecked tasks by section
    local counts=$(awk '
        /^## High Priority/ { section = "high"; next }
        /^## Medium Priority/ { section = "medium"; next }
        /^## Low Priority/ { section = "low"; next }
        /^## / { section = ""; next }

        section == "high" && /^- \[ \]/ { high++ }
        section == "medium" && /^- \[ \]/ { medium++ }
        section == "low" && /^- \[ \]/ { low++ }

        END { print (high+0) " " (medium+0) " " (low+0) }
    ' "$prd_file")

    read high medium low <<< "$counts"
    echo "High: $high, Medium: $medium, Low: $low"
}

# Update PRD status file
update_prd_status() {
    local prd_file="$1"
    local current_task="$2"
    local task_number="$3"
    local run_dir="${4:-}"

    mkdir -p "$(dirname "$PRD_STATUS_FILE")"

    local timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)

    cat > "$PRD_STATUS_FILE" <<EOF
{
    "prd_file": "$prd_file",
    "updated_at": "$timestamp",
    "current_task": "$current_task",
    "current_task_number": $task_number,
    "current_run_dir": "$run_dir",
    "progress": "$(count_tasks "$prd_file")",
    "by_priority": "$(count_by_priority "$prd_file")"
}
EOF
}

# Show PRD status
show_status() {
    local prd_file="$1"

    if [ ! -f "$PRD_STATUS_FILE" ]; then
        log_info "No PRD execution in progress"
        return
    fi

    echo "Current PRD Status:"
    cat "$PRD_STATUS_FILE" | jq . 2>/dev/null || cat "$PRD_STATUS_FILE"
    echo ""

    if [ -f "$prd_file" ]; then
        echo "Task Summary:"
        echo "  Total: $(count_tasks "$prd_file")"
        echo "  By Priority: $(count_by_priority "$prd_file")"
    fi
}

# List all tasks with status
list_tasks() {
    local prd_file="$1"

    echo "PRD Tasks:"
    echo ""

    # High Priority
    if grep -q '^## High Priority' "$prd_file"; then
        echo -e "${YELLOW}High Priority:${NC}"
        awk '
            /^## High Priority/ { in_section = 1; next }
            /^## / { in_section = 0; next }
            in_section && /^- \[.\]/ { print "  " $0 }
        ' "$prd_file"
        echo ""
    fi

    # Medium Priority
    if grep -q '^## Medium Priority' "$prd_file"; then
        echo -e "${YELLOW}Medium Priority:${NC}"
        awk '
            /^## Medium Priority/ { in_section = 1; next }
            /^## / { in_section = 0; next }
            in_section && /^- \[.\]/ { print "  " $0 }
        ' "$prd_file"
        echo ""
    fi

    # Low Priority
    if grep -q '^## Low Priority' "$prd_file"; then
        echo -e "${YELLOW}Low Priority:${NC}"
        awk '
            /^## Low Priority/ { in_section = 1; next }
            /^## / { in_section = 0; next }
            in_section && /^- \[.\]/ { print "  " $0 }
        ' "$prd_file"
        echo ""
    fi

    echo "Summary: $(count_tasks "$prd_file")"
}

# Main PRD execution loop
run_prd_loop() {
    local prd_file="$1"

    log_prd "Starting PRD execution: $prd_file"
    log_info "Progress: $(count_tasks "$prd_file")"
    log_info "Remaining by priority: $(count_by_priority "$prd_file")"
    echo ""

    local task_number=0
    local start_time=$(date +%s)

    while has_tasks "$prd_file"; do
        task_number=$((task_number + 1))

        # Get next task
        local task=$(get_next_task "$prd_file")

        if [ -z "$task" ]; then
            log_success "All tasks complete!"
            break
        fi

        local priority=$(get_task_priority "$prd_file" "$task")

        echo ""
        log_prd "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        log_prd "PRD Task #$task_number [Priority: $priority]"
        log_prd "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo -e "${YELLOW}Task:${NC} $task"
        echo -e "${YELLOW}Remaining:${NC} $(count_by_priority "$prd_file")"
        echo ""

        # Estimate which run directory ralph will create (for status tracking)
        local run_id="ralph-$(date +%Y%m%d-%H%M%S)"
        local run_dir=".ralph/runs/$run_id"

        # Update status
        update_prd_status "$prd_file" "$task" "$task_number" "$run_dir"

        # Execute ralph with this task
        log_info "Executing Ralph workflow for this task..."
        log_info "Command: $RALPH_CMD \"$task\""
        echo ""

        if RALPH_MAX_ITERATIONS="$RALPH_MAX_ITERATIONS" \
           RALPH_CLAUDE_COMMAND="$RALPH_CLAUDE_COMMAND" \
           RALPH_AUTO_APPROVE_PUSH="$RALPH_AUTO_APPROVE_PUSH" \
           "$RALPH_CMD" "$task"; then

            # Success - mark task complete
            echo ""
            mark_complete "$prd_file" "$task"
            log_success "‚úì PRD Task #$task_number completed successfully"

            # Show progress
            log_info "Overall progress: $(count_tasks "$prd_file")"

        else
            # Failure - stop and report
            echo ""
            log_error "‚úó PRD Task #$task_number failed"
            log_error "Task: $task"
            log_error "Priority: $priority"
            echo ""
            log_error "Ralph workflow execution failed. Options:"
            log_error "  1. Review the error logs in the run directory"
            log_error "  2. Fix issues manually"
            log_error "  3. Resume with: ralph-prd --resume $prd_file"
            echo ""
            log_info "Current run directory: $run_dir"
            log_info "Progress: $(count_tasks "$prd_file")"

            return 1
        fi

        # Brief pause between tasks
        sleep 3
    done

    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    local hours=$((duration / 3600))
    local minutes=$(((duration % 3600) / 60))

    echo ""
    log_success "üéâ All PRD tasks completed successfully!"
    log_info "Final status: $(count_tasks "$prd_file")"
    log_info "Total time: ${hours}h ${minutes}m"
    echo ""
}

# Main
main() {
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --help|-h)
                usage
                exit 0
                ;;
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            --resume)
                RESUME_MODE=true
                shift
                ;;
            --status)
                if [[ -n "${2:-}" && "${2:0:1}" != "-" ]]; then
                    show_status "$2"
                else
                    show_status "PRD.md"
                fi
                exit 0
                ;;
            -*)
                log_error "Unknown option: $1"
                usage
                exit 1
                ;;
            *)
                PRD_FILE="$1"
                shift
                ;;
        esac
    done

    # Validate PRD file
    if [ -z "$PRD_FILE" ]; then
        log_error "PRD file required"
        echo ""
        usage
        exit 1
    fi

    if [ ! -f "$PRD_FILE" ]; then
        log_error "PRD file not found: $PRD_FILE"
        exit 1
    fi

    # Check ralph exists
    if [ ! -x "$RALPH_CMD" ]; then
        log_error "ralph not found at: $RALPH_CMD"
        log_error "Make sure bin/ralph exists and is executable"
        exit 1
    fi

    # Validate PRD format
    if ! grep -q '^## High Priority\|^## Medium Priority\|^## Low Priority' "$PRD_FILE"; then
        log_warning "PRD file should contain priority sections:"
        log_warning "  ## High Priority"
        log_warning "  ## Medium Priority"
        log_warning "  ## Low Priority"
        echo ""
    fi

    # Dry run mode
    if [ "$DRY_RUN" = true ]; then
        log_info "Dry run mode - tasks that would be executed:"
        echo ""
        list_tasks "$PRD_FILE"
        exit 0
    fi

    # Check for unchecked tasks
    if ! has_tasks "$PRD_FILE"; then
        log_success "All tasks in PRD are already complete!"
        log_info "Status: $(count_tasks "$PRD_FILE")"
        exit 0
    fi

    # Resume mode
    if [ "$RESUME_MODE" = true ]; then
        log_info "Resume mode - continuing from last checkpoint"
        if [ -f "$PRD_STATUS_FILE" ]; then
            log_info "Previous status:"
            show_status "$PRD_FILE"
            echo ""
        fi
    fi

    # Show environment configuration
    log_info "Configuration:"
    log_info "  Claude command: $RALPH_CLAUDE_COMMAND"
    log_info "  Max iterations per task: $RALPH_MAX_ITERATIONS"
    log_info "  Auto-approve push: $RALPH_AUTO_APPROVE_PUSH"
    echo ""

    # Run PRD loop
    run_prd_loop "$PRD_FILE"
}

main "$@"
